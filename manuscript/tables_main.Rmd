---
title: Tables for main manuscript
output:
    word_document:
      df_print: kable
      reference_docx: style_rmd.docx
    md_document:
      variant: gfm
      df_print: kable
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(knitr.kable.NA = 'â€”')
```

```{r counter}
library(dplyr)
library(readr)
library(readxl)
library(openxlsx)
library(tidyr)
library(stringr)
library(knitr)

# table index
table_index <- 0
```

```{r create_main_xlsx_fun, include=FALSE}
create_main_xlsx <- function(sheet_name, legend, results_table, table_idx) {
# Create and write to workbook
wb <- createWorkbook()
addWorksheet(wb, sheet_name)

# Write the legend to A1
writeData(wb, sheet = 1, x = legend, startCol = 1, startRow = 1)

# Write the formatted table starting at row 3
writeData(wb, sheet = 1, x = results_table, startCol = 1, startRow = 3)

# Merge and center legend text over multiple cells
n_cols <- ncol(results_table) + 1
mergeCells(wb, sheet = 1, cols = 1:n_cols, rows = 1)

# Change legend cell width and height
setRowHeights(wb, sheet = sheet_name, rows = 1, heights = 80)

# Wrap text in legend cell
wrap_style <- createStyle(wrapText = TRUE)
# use stack = TRUE to ensure multiple styles can be added, else it will overwrite
addStyle(wb, sheet = sheet_name, style = wrap_style, rows = 1, cols = 1, stack = TRUE)

# Make legend bold
bold_style <- createStyle(textDecoration = "bold")
addStyle(wb, sheet = sheet_name, style = bold_style, rows = 1, cols = 1, stack = TRUE)
addStyle(wb, sheet = sheet_name, style = bold_style, rows = 3, cols = 1:6, stack = TRUE)

# Save workbook
file_name <- paste0("Table_", table_idx,".xlsx")
file_path <- here::here("manuscript/tables/", file_name)
saveWorkbook(wb, file_path , overwrite = TRUE)
}
```


```{r sample_size}
# summary sample size counts for fixed and mr-mega analyis
# break down by cluster for fixed, just show totals for MR-MEGA
# count number of cohorts and sample sizes for case, control, and neff
sample_size_table_idx <- table_index <- table_index + 1
summary_table_fixed <- read_csv(here::here("manuscript/tables/meta_analysis_cohort_summary_table_fixed.csv")) |>
  mutate(method = "fixed") |>
  separate(meta_analysis,
           into = c("meta", "version", "method", "ATC", "cluster"))

summary_table_mrmega <- read_csv(here::here("manuscript/tables/meta_analysis_cohort_summary_table_mrmega.csv")) |>
  mutate(method = "mrmega") |>
  separate(meta_analysis, into = c("meta", "version", "method", "ATC"))

sample_size_table <-
bind_rows(summary_table_fixed, summary_table_mrmega) |>
  pivot_longer(cols = matches("(cases|controls|neff)"),
               names_to = c("cohort", "status"),
               names_sep = "_",
               values_to = "N") |>
  filter(!is.na(N)) |>
  pivot_wider(names_from = status, values_from = N) |>
  mutate(Cluster=if_else(method == "mrmega",
                         true = "MR-MEGA",
                         false = cluster)) |>
  group_by(method, ATC, Cluster) |>
  summarize(`N studies` = n(), across(cases:neff, sum)) |>
  transmute(ATC, Cluster, `N studies`, Cases = cases, Controls = controls,
            `Neff/2` = round(neff/2, 2)) |>
  ungroup() |>
  select(-method)
```

**Table `r sample_size_table_idx`:** Sample sizes for GWAS meta-analyses. Fixed-effects analyses are listed separately for each population cluster (AFR, AMR, EAS, EUR, MID, and SAS) and totals are given for the multi-ancestry analysis (MR-MEGA). Neff/2 = half effective sample size. ATC = Anatomical Therapeutic Chemical classification subgroups (N06A: antidepressants; N06AA: non-selective monoamine reuptake inhibitors; N06AB: selective serotonin reuptake inhibitors).

```{r sample_size_table}
# print thousands seperator
kable(sample_size_table,
      format.args = list(big.mark = ","))

sample_size_table_formatted <- sample_size_table |>
  mutate(across(c(Cases, Controls, `Neff/2`), ~ format(.x, big.mark = ",", scientific = FALSE)))

# save as xlsx
legend <- paste0("Table ", sample_size_table_idx, ": Sample sizes for GWAS meta-analyses. Fixed-effects analyses are listed separately for each population cluster (AFR, AMR, EAS, EUR, MID, and SAS) and totals are given for the multi-ancestry analysis (MR-MEGA). Neff/2 = half effective sample size. ATC = Anatomical Therapeutic Chemical classification subgroups (N06A: antidepressants; N06AA: non-selective monoamine reuptake inhibitors; N06AB: selective serotonin reuptake inhibitors).")

sheet_name <- "Sample sizes"

create_main_xlsx(sheet_name, legend, sample_size_table_formatted, sample_size_table_idx)

```

```{r drug_targets}
# top drug target associations.
drug_target_table_idx <- table_index <- table_index + 1
drug_targets_class <- read_excel(here::here("manuscript/tables/antidep-2501-fixed-N06A-EUR.pathway.output_drugsAllp.drugclass_with4.selp.xls"))
drug_targets_all <- read_excel(here::here("manuscript/tables/antidep-2501-fixed-N06A-EUR.pathway.output_drugsAllpEUR.pathway.output_drugsAllp.xls"))

drug_targets <- drug_targets_class |>
  filter(q_valueBH <= 0.05) |>
  transmute(ATC = CODE, Name = str_to_title(NAME), N, AUC = round(AUC, 3), `Q value` = round(q_valueBH, 3))
```

**Table `r drug_target_table_idx`:** Drug target enrichment. ATC = Anatomical
Therapeutic Chemical classification subgroup. AUC = Area Under the Curve. Q = Significance corrected for multiple testing (Benjamini & Hochberg).

```{r drug_targets_table}
drug_targets

# save as xlsx
create_main_xlsx("Drug targets", 
              paste0("Table ", drug_target_table_idx, ": Drug target enrichment. ATC = Anatomical Therapeutic Chemical classification subgroup. AUC = Area Under the Curve. Q = Significance corrected for multiple testing (Benjamini & Hochberg)."),
              drug_targets, drug_target_table_idx)
```

```{r gwas_summary}
# summary of comparisons with MDD GWAS
gwas_summary_table_idx <- table_index <- table_index + 1
gwas_summary <- read_csv(here::here("manuscript/tables/antidep_gwas_mdd_gwas_summary_table.csv")) |>
  rename("N06A (MR-MEGA)" = `cross-ancestry_N06A`,
          "N06A (EUR)" = EUR_N06A,
          "N06AA (EUR)" = EUR_N06AA,
          "N06AB (EUR)" = EUR_N06AB)
# set name of row names to empty
names(gwas_summary)[1] <- ""
```

