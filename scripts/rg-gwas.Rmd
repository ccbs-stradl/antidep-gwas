---
title: Between GWAS genetic correlations
output: github_document
---

```{r library}
library(readr)
library(dplyr)
library(ggplot2)
library(corrplot)
library(stringr)
```

Read in LDSC (within-ancestry) and Popcorn (cross ancestry) genetic correlation estimates. Retain only estimates where $se <= 1/1.96 = 0.51$ (i.e., if $r_g = 1$ it could be distinguished from zero).

```{r tables}
ldsc <- read_csv(here::here("manuscript/tables/rg_ldsc_gwas.csv"))
popcorns <- read_csv(here::here("manuscript/tables/rg_popcorn_gwas.csv"))

rgs <-
bind_rows(
    ldsc,
    rename(popcorns, rg = pgi, se = SE, z = Z, p = `P (Z)`)
) |>
filter(se <= 1/qnorm(0.975))
```

Set up dataset names for correlation matrix
```{r datasets}
p1_datasets <- rgs |>
    mutate(dataset = str_c(p1_cohort, p1_pheno, p1_cluster, sep = "-")) |>
    pull(dataset)

p2_datasets <- rgs |>
    mutate(dataset = str_c(p2_cohort, p2_pheno, p2_cluster, sep = "-")) |>
    pull(dataset)

datasets <- unique(c(p1_datasets, p2_datasets))

rg <- rgs |> pull(rg)
```

Matrix to store correlations
```{r matrix}
rg_matrix <- matrix(data = NA,
                    nrow = length(datasets),
                    ncol = length(datasets),
                    dimnames = list(datasets, datasets))

for(i in seq_along(rg)) {
    dataset1 <- p1_datasets[i]
    dataset2 <- p2_datasets[i]
    rg_matrix[dataset1, dataset2] <- rg_matrix[dataset2, dataset1] <- rg[i]
}
```

Squish genetic correlations to (-1, 1)
```{r, squish}
rg_matrix_squish <- rg_matrix
rg_matrix_squish[rg_matrix > 2] <- NA
rg_matrix_squish[rg_matrix < -2] <- NA
rg_matrix_squish[rg_matrix < 2 & rg_matrix > 1] <- 1
rg_matrix_squish[rg_matrix > -2 & rg_matrix < -1] <- -1
```

Correlation plots

```{r corrplot, fig.size = 10, fig.height=10, dpi=218}
corrplot(rg_matrix, is.corr = FALSE)
```

```{r corrplot_squish, fig.size=10, fig.height=10, dpi=218}
corrplot(rg_matrix_squish)
```

Text to paste in manuscript results section for min/max observed correlations.
```{r text, results='asis'}
# get unique rgs
rgs_distinct <- rgs |>
  filter(p1_cohort <= p2_cohort, p1_pheno <= p2_pheno, p1_cluster <= p2_cluster) |>
  mutate(rg = signif(rg, digits = 3))

# within ancestry, cross cohort
rg_w_anc_x_cohort <- rgs_distinct |>
  filter(p1_cluster == p2_cluster, p1_cohort != p2_cohort)
# cross ancestry, within cohort
rg_x_anc_w_cohort <- rgs_distinct |>
  filter(p1_cluster != p2_cluster, p1_cohort == p2_cohort)
# cross ancestry, cross cohort
rg_x_anc_x_cohort <- rgs_distinct |>
  filter(p1_cluster != p2_cluster, p1_cohort != p2_cohort)

correlation_text <- function(correlations, intro_text) {
  cmin <- correlations |>
    filter(rg == min(rg))
  cmax <- correlations |>
    filter(rg == max(rg))

  str_glue("{intro_text} r_g ranged from {cmin$rg} between {cmin$p1_pheno} in {cmin$p1_cohort} {cmin$p1_cluster} and {cmin$p2_pheno} in {cmin$p2_cohort} {cmin$p2_cluster} to {cmax$rg} between {cmax$p1_pheno} in {cmax$p1_cohort} {cmax$p1_cluster} and {cmax$p2_pheno} in {cmax$p2_cohort} {cmax$p2_cluster}.")
}

cat(correlation_text(rg_w_anc_x_cohort, "Within clusters and across cohorts,"), " ", correlation_text(rg_x_anc_x_cohort, "Across clusters and cohorts,"))
```

